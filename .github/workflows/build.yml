name: Pipeline de Calidad y Seguridad (Sonar, Semgrep, Trivy)

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # -----------------------------------------------------------------
  # JOB 1: SONARCLOUD & TESTS
  # -----------------------------------------------------------------
  sonarcloud:
    name: SonarCloud & Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: 'zulu'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.35.2'

      - name: Install dependencies
        run: flutter pub get

      - name: Create Dummy Service Account
        run: |
          mkdir -p assets/keys
          echo '{}' > assets/keys/service_account.json

      - name: Run Tests with Coverage
        run: flutter test --coverage --dart-define=API_TOKEN="${{ secrets.API_TOKEN }}"

      - name: Fix Coverage Paths
        run: |
          sed -i "s|SF:lib/|SF:$GITHUB_WORKSPACE/lib/|g" coverage/lcov.info

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            "-Dsonar.organization=cdhm"
            "-Dsonar.projectKey=dennisdhm7_proyecto_sosmascota"
            "-Dsonar.sources=lib"
            "-Dsonar.tests=test"
            "-Dsonar.dart.lcov.reportPaths=coverage/lcov.info"
            "-Dsonar.coverage.reportPaths=coverage/lcov.info"
            "-Dsonar.exclusions=test/**/*,lib/**/*.g.dart,lib/firebase_options.dart"

  # -----------------------------------------------------------------
  # JOB 2: SEMGREP (SARIF)
  # -----------------------------------------------------------------
  security-semgrep:
    name: Security - Semgrep
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    if: (github.actor != 'dependabot[bot]')
    steps:
      - uses: actions/checkout@v3

      - name: Run Semgrep (SARIF output)
        run: semgrep scan --config=p/default --config=p/security-audit --config=p/secrets --sarif -o semgrep.sarif

      - name: Upload SARIF
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: semgrep.sarif

  # -----------------------------------------------------------------
  # Convert Semgrep SARIF ‚Üí HTML
  # -----------------------------------------------------------------
  convert-semgrep-html:
    name: Convert Semgrep SARIF to HTML
    runs-on: ubuntu-latest
    needs: security-semgrep
    steps:
      - uses: actions/checkout@v3

      - name: Download SARIF Artifact
        uses: actions/download-artifact@v4
        with:
          name: semgrep-sarif
          path: .

      - name: Install SARIF Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y pipx
          pipx ensurepath
          pipx install sarif-tools

      - name: Convert to HTML
        run: sarif html semgrep.sarif > semgrep-report.html

      - name: Upload HTML
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-html
          path: semgrep-report.html

  # -----------------------------------------------------------------
  # JOB 3: TRIVY ‚Üí JSON ‚Üí HTML
  # -----------------------------------------------------------------
  security-trivy:
    name: Security - Trivy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Trivy
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg >/dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Run Trivy (JSON)
        run: trivy fs . --format json --output trivy.json --severity CRITICAL,HIGH --ignore-unfixed

      - name: Convert JSON ‚Üí HTML
        run: |
          echo "<html><body><h1>Reporte Trivy</h1><pre>" > trivy-report.html
          cat trivy.json >> trivy-report.html
          echo "</pre></body></html>" >> trivy-report.html

      - name: Upload Trivy HTML
        uses: actions/upload-artifact@v4
        with:
          name: trivy-html
          path: trivy-report.html

  # -----------------------------------------------------------------
  # JOB 4: ReportGenerator
  # -----------------------------------------------------------------
  generate-report:
    name: Generate Detailed Risk Report
    runs-on: ubuntu-latest
    needs: sonarcloud
    steps:
      - uses: actions/checkout@v3

      - name: Install .NET SDK 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Add to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Copy coverage
        run: cp coverage/lcov.info .

      - name: Generate HTML Coverage Report
        run: reportgenerator -reports:lcov.info -targetdir:coverage_risk_html -reporttypes:Html

      - name: Upload risk report
        uses: actions/upload-artifact@v4
        with:
          name: risk-coverage-report
          path: coverage_risk_html

  # -----------------------------------------------------------------
  # JOB 5: Build Documentation Portal
  # -----------------------------------------------------------------
  build-docs:
    name: Build Documentation Portal
    runs-on: ubuntu-latest
    needs: [sonarcloud, convert-semgrep-html, security-trivy, generate-report]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Build Portal
        run: |
          mkdir _site
          mkdir -p _site/reports
          mkdir -p _site/reports/risk_report

          mv artifacts/risk-coverage-report/* _site/reports/risk_report/
          mv artifacts/semgrep-html/semgrep-report.html _site/reports/semgrep.html
          mv artifacts/trivy-html/trivy-report.html _site/reports/trivy.html

          echo '<html>
          <head><title>Portal de Reportes SOS Mascotas</title></head>
          <body>
            <h1>üêæ Portal de Reportes SOS Mascotas üêæ</h1>
            <h2>Seguridad</h2>
            <a href="reports/semgrep.html">Semgrep</a><br>
            <a href="reports/trivy.html">Trivy</a>
            <h2>Calidad</h2>
            <a href="reports/risk_report/index.htm">Cobertura Detallada</a>
          </body>
          </html>' > _site/index.html

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  # -----------------------------------------------------------------
  # JOB 6: Deploy Pages
  # -----------------------------------------------------------------
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4
